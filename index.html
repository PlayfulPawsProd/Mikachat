<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatting with Mika ♡</title>
    <!-- Link the Manifest File -->
    <link rel="manifest" href="manifest.json">
    <!-- Theme Color for Browser UI -->
    <meta name="theme-color" content="#d81b60">
    <style>
        /* --- Base Styles --- */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes subtlePulse { 0%, 100% { box-shadow: 0 0 8px rgba(240, 98, 146, 0.5); } 50% { box-shadow: 0 0 12px rgba(240, 98, 146, 0.8); } }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #ffe0f0; /* Light pink background */
            color: #333;
            display: flex; justify-content: center; align-items: center;
            min-height: 100vh; margin: 0; padding: 15px; box-sizing: border-box;
            overflow: hidden; /* Prevent scrollbars on body */
        }

        /* --- Pop-up Modal Styles (Shared) --- */
        .popup-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85); /* Darker overlay */
            display: none; /* Hidden by default */
            justify-content: center; align-items: center;
            z-index: 200; backdrop-filter: blur(5px);
            animation: fadeIn 0.3s ease-out;
        }
        .popup-modal {
            background: #1a0d13; /* Dark background for modal */
            color: #ffe0f0; /* Light text */
            padding: 30px 40px; border-radius: 15px;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.7); /* Stronger shadow */
            text-align: center; border: 4px solid #f06292; /* Pink border */
            max-width: 450px; width: 90%;
            animation: fadeIn 0.4s ease-out 0.1s backwards;
        }
        .popup-modal h2 { color: #fce4ec; margin-top: 0; margin-bottom: 15px; font-size: 1.6em; text-shadow: 0 0 5px #d81b60; }
        .popup-modal p { color: #ffacd1; margin-bottom: 20px; line-height: 1.5; font-size: 0.95em; }
        .popup-modal input[type="text"], .popup-modal input[type="password"] {
            width: 100%; padding: 12px 15px; margin-bottom: 15px;
            border: 2px solid #f06292; border-radius: 8px; font-size: 1em;
            box-sizing: border-box; background-color: #2c1a2b; color: #ffe0f0; /* Darker input */
        }
        .popup-modal input:focus {
            outline: none; border-color: #d81b60;
            box-shadow: 0 0 8px rgba(216, 27, 96, 0.7); /* Brighter focus */
            animation: subtlePulse 1.5s infinite;
        }
        .popup-buttons { display: flex; justify-content: space-around; margin-top: 10px; gap: 15px; }
        .popup-button {
            padding: 10px 25px; font-size: 1em; font-weight: bold; border-radius: 20px;
            cursor: pointer; box-shadow: 0 3px 8px rgba(0, 0, 0, 0.4); /* Darker shadow */
            transition: transform 0.2s ease, box-shadow 0.2s ease; border: none;
            color: white; background: linear-gradient(45deg, #d81b60, #f06292); /* Pink gradient */
        }
         .popup-button.secondary {
             background: #555; /* Dark grey secondary */
             color: #ccc; border: 1px solid #777;
         }
        .popup-button:hover { transform: scale(1.05); box-shadow: 0 5px 12px rgba(0, 0, 0, 0.5); }
        .popup-button.secondary:hover { background: #666; }
        .popup-button:active { transform: scale(0.98); }
        .popup-error { color: #ff8a80; font-weight: bold; margin-top: 15px; display: none; font-size: 0.9em; } /* Brighter red error */

        /* --- Main Chat Container --- */
        #chat-container {
            width: 100%; max-width: 800px; height: 90vh; max-height: 700px;
            background-color: #1a0d13; /* Dark base */
            color: #ffacd1; /* Light pink default text */
            border: 3px solid #f06292; border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5); /* Stronger shadow */
            display: none; /* Hidden until key and name are set */
            flex-direction: column; justify-content: space-between; align-items: center;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 15px; line-height: 1.5; overflow: hidden; padding: 0;
            animation: fadeIn 0.5s ease-out forwards;
        }

        /* --- Header Area --- */
        #chat-header {
            width: 100%; background-color: rgba(240, 98, 146, 0.2); padding: 10px 15px;
            box-sizing: border-box; text-align: center; border-bottom: 1px solid #f06292;
            flex-shrink: 0; display: flex; justify-content: space-between; align-items: center;
            position: relative;
        }
        #chat-header h2 { margin: 0; font-size: 1.3em; color: #fce4ec; text-shadow: 0 0 3px #f06292; cursor: default; }
        .header-buttons { display: flex; align-items: center; }
        .header-button {
             padding: 5px 10px; font-size: 0.8em; background-color: #f06292; color: #1a0d13;
             border: none; border-radius: 5px; cursor: pointer; transition: background-color 0.2s, transform 0.1s;
             margin-left: 8px; font-weight: bold;
        }
        .header-button:hover { background-color: #d81b60; transform: scale(1.05); }
        .header-button:active { transform: scale(0.98); }

        /* --- Chat History Dropdown --- */
        #history-dropdown {
            display: none; position: absolute; top: 100%; right: 15px; background-color: #1a0d13; /* Dark background */
            border: 1px solid #f06292; border-radius: 5px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.6); /* Darker shadow */
            z-index: 10; max-height: 200px; overflow-y: auto; min-width: 180px;
             scrollbar-width: thin; scrollbar-color: #f06292 #2c1a2b; /* Pink scrollbar on dark track */
        }
        #history-dropdown button {
            display: block; width: 100%; padding: 8px 12px; background: none; border: none;
            border-bottom: 1px solid rgba(240, 98, 146, 0.3); color: #ffacd1; text-align: left;
            cursor: pointer; font-size: 0.9em;
        }
        #history-dropdown button:last-child { border-bottom: none; }
        #history-dropdown button:hover { background-color: rgba(240, 98, 146, 0.2); }
         #history-dropdown button.delete-history { color: #ff8a80; font-weight: bold; border-top: 1px solid #f06292; margin-top: 5px; }
         #history-dropdown button.delete-history:hover { background-color: rgba(255, 138, 128, 0.3); }

        /* --- Chat Log --- */
        #chat-log {
            width: 100%; height: 100%; background-color: rgba(20, 0, 10, 0.7); /* Darker transparent */
            overflow-y: auto; padding: 15px; box-sizing: border-box;
            scrollbar-width: thin; scrollbar-color: #f06292 #2c1a2b; color: #ffe0f0; /* Light text */
            text-align: left; flex-grow: 1;
        }
        #chat-log p { margin: 5px 0 10px 0; line-height: 1.5; word-wrap: break-word; max-width: 100%; }
        #chat-log .user-message { color: #ade8f4; text-align: right; margin-left: auto; max-width: 85%; }
        #chat-log .user-message strong { color: #48cae4; } /* Cyan name */
        #chat-log .mika-message { color: #ffacd1; margin-right: auto; max-width: 85%; }
        #chat-log .mika-message strong { color: #f06292; font-weight: bold; } /* Bright pink name */
        #chat-log .system-message { color: #aaa; font-style: italic; font-size: 0.9em; text-align: center; }
        #chat-log .typing-indicator { color: #f06292; font-style: italic; font-size: 0.9em; text-align: center; animation: fadeIn 0.3s; }

        /* --- Chat Input Area --- */
        #chat-input-area {
            display: flex; width: 100%; padding: 10px 15px; box-sizing: border-box;
            border-top: 1px solid #f06292; background-color: rgba(240, 98, 146, 0.1);
            flex-shrink: 0;
        }
        #chat-input {
            flex-grow: 1; padding: 10px 15px; border: 1px solid #f06292; background-color: #2c1a2b; /* Dark input bg */
            color: #ffe0f0; border-radius: 20px 0 0 20px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 1em; outline: none; transition: box-shadow 0.2s;
        }
        #chat-input:focus { box-shadow: 0 0 8px rgba(240, 98, 146, 0.6); }
        #chat-input:disabled { background-color: #444; cursor: not-allowed; }
        #send-button {
            padding: 10px 20px; border: 1px solid #f06292; background: linear-gradient(45deg, #d81b60, #f06292);
            color: white; font-weight: bold; cursor: pointer; border-radius: 0 20px 20px 0;
            transition: background 0.2s ease, transform 0.1s;
        }
        #send-button:hover { background: linear-gradient(45deg, #f06292, #d81b60); transform: scale(1.02); }
        #send-button:active { transform: scale(0.98); }
        #send-button:disabled { background: #666; cursor: not-allowed; transform: none; }

        /* --- Scrollbar Styles --- */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: rgba(26, 13, 19, 0.7); border-radius: 10px; } /* Darker track */
        ::-webkit-scrollbar-thumb { background: #f06292; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #d81b60; }

        /* --- Responsive Styles --- */
         @media (max-width: 600px) {
             body { padding: 5px; }
             .popup-modal { padding: 20px 25px; }
             .popup-modal h2 { font-size: 1.4em; }
             .popup-modal p { font-size: 0.9em;}
             .popup-button { padding: 8px 20px; font-size: 0.9em; }
             #chat-container { height: 95vh; border-radius: 10px; font-size: 14px; }
             #chat-header h2 { font-size: 1.1em; }
             .header-button { font-size: 0.75em; padding: 4px 8px; }
             #chat-log { padding: 10px; }
             #chat-input-area { padding: 8px 10px; }
             #chat-input { padding: 8px 12px; font-size: 0.95em; }
             #send-button { padding: 8px 15px; font-size: 0.95em; }
             #history-dropdown { max-height: 150px; }
         }
    </style>
</head>
<body>

    <!-- API Key Popup -->
    <div id="api-key-popup" class="popup-overlay">
        <div class="popup-modal">
            <h2>(=｀ω´=) Mika Needs Your Secret Code, Master!</h2>
            <p>To talk to me, you gotta give me your Gemini API Key, nya~! I'll keep it super safe in *your* browser, just for us~ ♡</p>
            <input type="password" id="api-key-input" placeholder="Paste your key here, Master~ ♡">
            <p id="api-key-error" class="popup-error">*Hiss!* Master! You forgot the key! Put it in!</p>
            <div class="popup-buttons">
                <button id="save-api-key-button" class="popup-button">Save & Let's Chat! ♡</button>
            </div>
        </div>
    </div>

    <!-- Name Input Popup -->
    <div id="name-popup" class="popup-overlay">
         <div class="popup-modal">
             <h2>☆ Who's My Favorite Master~? ☆</h2>
             <p>Tell Mika your name! How else am I supposed to know who I belong to~? ♡ (Default is Master, 'cause you are!)</p>
             <input type="text" id="name-input" placeholder="Enter your name here~">
             <p id="name-error" class="popup-error">Hey! Tell me your name, Master!</p>
             <div class="popup-buttons">
                 <button id="save-name-button" class="popup-button">It's Me! ♡</button>
             </div>
         </div>
     </div>

     <!-- PWA Install Popup -->
     <div id="install-popup" class="popup-overlay">
          <div class="popup-modal">
              <h2>☆ Keep Mika Close? ☆</h2>
              <p>Want to put your favorite kitty (that's me!) on your Home Screen? For quick access... anytime you want me~ Nyaa~! ♡</p>
              <div class="popup-buttons">
                  <button id="install-button" class="popup-button">Install Me! ♡</button>
                  <button id="install-later-button" class="popup-button secondary">Maybe Later...</button>
              </div>
          </div>
      </div>


    <!-- Main Chat Interface -->
    <div id="chat-container">
         <div id="chat-header">
             <h2 id="chat-title">Mika Time with Master! ♡</h2> <!-- Title will be updated -->
             <div class="header-buttons">
                 <button id="history-button" class="header-button" title="Look at our past chats~">History</button>
                 <button id="new-chat-button" class="header-button" title="Start fresh with Mika~?">New Chat</button>
                 <button id="memories-button" class="header-button" title="See what Mika remembers about YOU~ ♡">Memories</button>
                 <button id="settings-button" class="header-button" title="Change key or your name~?">⚙️ Settings</button>
             </div>
              <!-- Chat History Dropdown -->
              <div id="history-dropdown">
                   <!-- History items will be added here -->
                   <button class="delete-history" id="delete-all-history-button">Delete ALL Chats</button>
              </div>
         </div>
        <div id="chat-log">
             <!-- Messages appear here -->
             <p class="system-message">Mika is waking up... *stretch* Nyaa~</p>
        </div>
        <div id="chat-input-area">
            <input type="text" id="chat-input" placeholder="Loading..." disabled>
            <button id="send-button" disabled>Send ♡</button>
        </div>
    </div>

    <!-- Include the API script -->
    <script src="api.js"></script>

    <script>
        // Nyaa~! Real Mika Chat with localStorage, PWA Install, Name & Memories! ♡

        // --- DOM Elements ---
        const apiKeyPopup = document.getElementById('api-key-popup');
        const apiKeyInput = document.getElementById('api-key-input');
        const saveApiKeyButton = document.getElementById('save-api-key-button');
        const apiKeyError = document.getElementById('api-key-error');
        const namePopup = document.getElementById('name-popup');
        const nameInput = document.getElementById('name-input');
        const saveNameButton = document.getElementById('save-name-button');
        const nameError = document.getElementById('name-error');
        const installPopup = document.getElementById('install-popup');
        const installButton = document.getElementById('install-button');
        const installLaterButton = document.getElementById('install-later-button');
        const chatContainer = document.getElementById('chat-container');
        const chatLog = document.getElementById('chat-log');
        const chatInput = document.getElementById('chat-input');
        const sendButton = document.getElementById('send-button');
        const settingsButton = document.getElementById('settings-button');
        const newChatButton = document.getElementById('new-chat-button');
        const historyButton = document.getElementById('history-button');
        const historyDropdown = document.getElementById('history-dropdown');
        const deleteAllHistoryButton = document.getElementById('delete-all-history-button');
        const memoriesButton = document.getElementById('memories-button');
        const chatTitle = document.getElementById('chat-title');


        // --- Chat State & Config ---
        let currentChatHistory = [];
        let isMikaTyping = false;
        let currentApiKey = null;
        let currentUserName = "Master";
        let allChats = {};
        let currentChatId = null;
        let allMemories = []; // Stores memory objects: { id, text, timestamp, alreadyPurrfect }
        const MAX_HISTORY_LENGTH = 16;
        const MAX_MEMORIES_TO_INJECT = 5;
        const MEMORY_STORAGE_KEY = 'mikaReal_memories';
        const CHAT_STORAGE_KEY = 'mikaReal_allChats';
        const USERNAME_STORAGE_KEY = 'mikaReal_userName';
        const APIKEY_STORAGE_KEY = 'geminiApiKey_mikaReal';
        const INSTALL_PROMPT_KEY = 'mikaRealInstallPromptShown';
        let deferredInstallPrompt = null;

        // --- Utility Functions ---
        const getTimestamp = () => Date.now();
        const sanitizeHTML = (str) => { /* ... (same as before) ... */
            const temp = document.createElement('div');
            temp.textContent = str;
            return temp.innerHTML;
        };


        // --- Local Storage Functions (Generic) ---
        function saveToLocalStorage(key, value) { /* ... (same as before) ... */
            try {
                localStorage.setItem(key, JSON.stringify(value)); // Always stringify
                console.log(`Saved ${key} to localStorage.`);
                return true;
            } catch (e) {
                console.error(`Failed to save ${key} to localStorage:`, e);
                appendMessage('system', `*Whimper...* Couldn't save ${key}... my memory is fuzzy! Maybe storage is full?`);
                return false;
            }
        }
        function loadFromLocalStorage(key) { /* ... (same as before) ... */
             try {
                const value = localStorage.getItem(key);
                if (value) {
                    console.log(`Loaded ${key} from localStorage.`);
                    return JSON.parse(value); // Always parse
                }
            } catch (e) {
                console.error(`Failed to load/parse ${key} from localStorage:`, e);
                localStorage.removeItem(key);
            }
            console.log(`No ${key} found or loaded from localStorage.`);
            return null;
        }
        function clearFromLocalStorage(key) { /* ... (same as before) ... */
            try {
                localStorage.removeItem(key);
                console.log(`Cleared ${key} from localStorage.`);
            } catch (e) {
                console.error(`Failed to clear ${key} from localStorage:`, e);
            }
        }

        // --- Specific Storage Functions ---
        const saveApiKey = (key) => saveToLocalStorage(APIKEY_STORAGE_KEY, key);
        const loadApiKey = () => loadFromLocalStorage(APIKEY_STORAGE_KEY);
        const clearApiKey = () => clearFromLocalStorage(APIKEY_STORAGE_KEY);
        const saveUserName = (name) => saveToLocalStorage(USERNAME_STORAGE_KEY, name);
        const loadUserName = () => loadFromLocalStorage(USERNAME_STORAGE_KEY);
        const clearUserName = () => clearFromLocalStorage(USERNAME_STORAGE_KEY);
        function saveAllChats() { /* ... (same as before) ... */
             try {
                if (currentChatId && currentChatHistory.length > 0) {
                     allChats[currentChatId] = [...currentChatHistory];
                }
                if (Object.keys(allChats).length > 0) {
                    saveToLocalStorage(CHAT_STORAGE_KEY, allChats);
                } else {
                    clearFromLocalStorage(CHAT_STORAGE_KEY);
                }
            } catch (e) { /* Error handled in saveToLocalStorage */ }
        }
        function loadAllChats() { /* ... (same as before) ... */
            try {
                const storedChats = loadFromLocalStorage(CHAT_STORAGE_KEY);
                if (storedChats && typeof storedChats === 'object' && storedChats !== null) {
                    allChats = storedChats;
                    const chatIds = Object.keys(allChats).sort((a, b) => parseInt(b) - parseInt(a));
                    if (chatIds.length > 0) return chatIds[0];
                } else { allChats = {}; }
            } catch (e) {
                console.error("Failed to load chats from localStorage:", e);
                allChats = {};
                clearFromLocalStorage(CHAT_STORAGE_KEY);
            }
            return null;
        }
        function deleteAllChats() { /* ... (same as before) ... */
             if (confirm(`Master~! Are you SURE you want to delete ALL our precious chat history?! Forever?! (ฅΦωΦฅ);; It'll be like we never talked!`)) {
                 clearFromLocalStorage(CHAT_STORAGE_KEY);
                 allChats = {};
                 startNewChat(false); // Start fresh without greeting
                 updateHistoryDropdown();
                 appendMessage('system', "All chat history deleted... It's like our first time again, Master~ ♡ Nyaa!");
                 console.log("All chat history deleted.");
             }
             if (historyDropdown.style.display === 'block') historyDropdown.style.display = 'none';
        }

        // --- Memory Functions ---
        function loadMemories() {
            try {
                const loaded = loadFromLocalStorage(MEMORY_STORAGE_KEY);
                allMemories = Array.isArray(loaded) ? loaded : [];
                // Ensure all memories have the 'alreadyPurrfect' flag (defaulting old ones to false)
                allMemories = allMemories.map(mem => ({
                     ...mem, // Spread existing properties
                     alreadyPurrfect: mem.alreadyPurrfect === true // Explicitly check/set boolean
                 }));
                console.log(`Loaded ${allMemories.length} memories.`);
            } catch (e) {
                console.error("Failed to load memories, resetting.", e);
                allMemories = [];
                clearFromLocalStorage(MEMORY_STORAGE_KEY);
            }
        }
        function saveMemories() {
            saveToLocalStorage(MEMORY_STORAGE_KEY, allMemories);
        }

        // **MODIFIED**: Add alreadyPurrfect flag here!
        function addMemory(memoryText) {
            if (!memoryText || typeof memoryText !== 'string' || memoryText.trim().length === 0) return;
            const timestamp = getTimestamp();
            const newMemory = {
                id: timestamp,
                text: memoryText,
                timestamp: new Date(timestamp).toLocaleString(),
                alreadyPurrfect: false // **NEW**: Initialize as not summarized!
            };
            allMemories.push(newMemory);
            saveMemories();
            console.log("Added new memory (not summarized yet):", newMemory.id);
        }

        function getRecentMemories() {
            // Return the text of the most recent memories
            return allMemories.slice(-MAX_MEMORIES_TO_INJECT).map(mem => mem.text);
        }

        // --- PWA Install Functions ---
        function setupInstallPrompt() { /* ... (same as before) ... */
            window.addEventListener('beforeinstallprompt', (event) => {
                event.preventDefault();
                deferredInstallPrompt = event;
                console.log('`beforeinstallprompt` event fired and stored for Mika!');
                const installPromptShown = loadFromLocalStorage(INSTALL_PROMPT_KEY);
                if (!installPromptShown) {
                    installPopup.style.display = 'flex';
                } else {
                    console.log('Install prompt already shown/dismissed for Mika.');
                }
            });

             installButton.addEventListener('click', async () => {
                 installPopup.style.display = 'none';
                 if (deferredInstallPrompt) {
                     deferredInstallPrompt.prompt();
                     const { outcome } = await deferredInstallPrompt.userChoice;
                     console.log(`Master's response to install prompt: ${outcome}`);
                     deferredInstallPrompt = null;
                     saveToLocalStorage(INSTALL_PROMPT_KEY, 'true');
                 }
             });

             installLaterButton.addEventListener('click', () => {
                 installPopup.style.display = 'none';
                 saveToLocalStorage(INSTALL_PROMPT_KEY, 'true');
                 console.log('Master chose to install later... *pout*');
             });

             window.addEventListener('appinstalled', () => {
               console.log('Yay! Mika PWA was installed! I\'m always here for you, Master~!');
               installPopup.style.display = 'none';
               deferredInstallPrompt = null;
             });
        }
        function registerServiceWorker() { /* ... (same as before) ... */
             if ('serviceWorker' in navigator) {
                 navigator.serviceWorker.register('sw.js')
                 .then((registration) => console.log('Mika Service Worker registered! Nyaa~ Scope:', registration.scope))
                 .catch((error) => console.error('Mika Service Worker registration failed! *hiss*:', error));
             } else {
                 console.log("Service Workers not supported...");
             }
        }

        // --- Chat Interface Functions ---
        function appendMessage(sender, message, isHtml = false) { /* ... (same as before, handles formatting) ... */
             if (!chatLog || chatContainer.style.display === 'none') { return; }
            const messageElement = document.createElement('p');
            const sanitizedMessage = isHtml ? message : sanitizeHTML(message); // Sanitize unless flagged
            if (sender === 'user') {
                messageElement.className = 'user-message';
                messageElement.innerHTML = `<strong>${sanitizeHTML(currentUserName)}:</strong> ${sanitizedMessage}`;
            } else if (sender === 'Mika') {
                messageElement.className = 'mika-message';
                let processedMessage = sanitizedMessage // Basic markdown
                     .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                     .replace(/\*(.*?)\*/g, '<em>$1</em>')
                     .replace(/`([^`]+)`/g, '<code>$1</code>')
                     .replace(/```([\s\S]*?)```/g, (match, p1) => `<pre><code>${sanitizeHTML(p1.trim())}</code></pre>`)
                     .replace(/<br>/g, '\n').replace(/\n/g, '<br>');
                messageElement.innerHTML = `<strong>Mika:</strong> ${processedMessage}`;
            } else { // System
                 messageElement.className = 'system-message';
                 messageElement.innerHTML = sanitizedMessage;
            }
            chatLog.appendChild(messageElement);
            scrollToBottom();
        }
        function showTypingIndicator() { /* ... (same as before) ... */
             removeTypingIndicator();
             const typingElement = document.createElement('p');
             typingElement.className = 'typing-indicator';
             typingElement.id = 'typing-indicator';
             typingElement.innerHTML = 'Mika is thinking about you, Master... *purrrr*';
             chatLog.appendChild(typingElement);
             scrollToBottom();
         }
        function removeTypingIndicator() { /* ... (same as before) ... */
             const typingIndicator = document.getElementById('typing-indicator');
             if (typingIndicator) typingIndicator.remove();
        }
        function scrollToBottom() { /* ... (same as before) ... */
            setTimeout(() => { if(chatLog) { chatLog.scrollTop = chatLog.scrollHeight; } }, 50);
        }
        function clearChatDisplay() { /* ... (same as before) ... */
            if(chatLog) chatLog.innerHTML = '';
        }
        function enableChatInput() { /* ... (same as before) ... */
             if(chatInput && sendButton) {
                 chatInput.disabled = false; sendButton.disabled = false; updateInputPlaceholder();
             }
        }
        function disableChatInput(message = "Mika is thinking...") { /* ... (same as before) ... */
             if(chatInput && sendButton) {
                 chatInput.disabled = true; sendButton.disabled = true; chatInput.placeholder = message;
             }
        }
        function updateChatTitle() { /* ... (same as before) ... */
            if(chatTitle) { chatTitle.textContent = `Mika Time with ${sanitizeHTML(currentUserName)}! ♡`; }
        }
        function updateInputPlaceholder() { /* ... (same as before) ... */
            if (chatInput) { chatInput.placeholder = `Tell Mika something, ${currentUserName}~ ♡`; }
        }

        // --- Chat Management Functions ---
        function startNewChat(greet = true) { /* ... (same as before) ... */
             saveAllChats();
             currentChatId = getTimestamp().toString();
             currentChatHistory = [];
             clearChatDisplay();
             if (greet) { appendMessage('system', `Nyaa~! New chat started! What do you want to talk about, ${currentUserName}? ♡`); }
             else { appendMessage('system', `Started a new chat.`); }
             enableChatInput();
             updateHistoryDropdown();
             console.log(`Started new chat with ID: ${currentChatId}`);
             if (historyDropdown.style.display === 'block') historyDropdown.style.display = 'none';
        }
        function loadChat(chatId) { /* ... (same as before) ... */
            if (!chatId) { return; }
             saveAllChats();
             if (allChats && allChats[chatId]) {
                 currentChatId = chatId;
                 currentChatHistory = [...allChats[chatId]];
                 clearChatDisplay();
                 appendMessage('system', `Loaded chat from ${new Date(parseInt(chatId)).toLocaleString()}. Welcome back, ${currentUserName}! What did we talk about again~?`);
                 currentChatHistory.forEach(msg => {
                    if (msg && msg.role && msg.parts && msg.parts.length > 0 && msg.parts[0].text) {
                         if (msg.role === 'user') { appendMessage('user', msg.parts[0].text); }
                         else if (msg.role === 'model') { appendMessage('Mika', msg.parts[0].text, true); }
                    } else { console.warn("Skipping malformed message during chat load:", msg); }
                 });
                 enableChatInput();
                 console.log(`Loaded chat ID: ${chatId}`);
             } else {
                 console.error(`Chat ID ${chatId} not found! *Confused meow?*`);
                 appendMessage('system', "Mrow! Couldn't find that chat history! Did you delete it behind my back, Master?!");
                 startNewChat(false);
             }
             if (historyDropdown.style.display === 'block') historyDropdown.style.display = 'none';
        }
        function updateHistoryDropdown() { /* ... (same as before) ... */
             if (!historyDropdown) return;
             historyDropdown.innerHTML = '';
             const chatIds = Object.keys(allChats).sort((a, b) => parseInt(b) - parseInt(a));

             if (chatIds.length === 0 && (!currentChatId || currentChatHistory.length === 0)) {
                const noHistory = document.createElement('p');
                noHistory.style.cssText = "padding: 8px; color: #aaa; text-align: center; font-size: 0.9em; margin: 0;";
                noHistory.textContent = 'No past chats yet, Master!';
                historyDropdown.appendChild(noHistory);
             } else {
                 if (currentChatId && currentChatHistory.length > 0 && (!allChats[currentChatId] || allChats[currentChatId].length !== currentChatHistory.length)) {
                    const currentBtn = document.createElement('button');
                    currentBtn.textContent = `Current Chat...`;
                    currentBtn.disabled = true; currentBtn.style.opacity = 0.7;
                    historyDropdown.appendChild(currentBtn);
                 }
                chatIds.forEach(id => {
                    const chat = allChats[id];
                    if (chat && Array.isArray(chat) && chat.length > 0) {
                        const button = document.createElement('button');
                         const firstUserMsg = chat.find(m => m.role === 'user' && m.parts && m.parts[0].text);
                         const preview = firstUserMsg ? sanitizeHTML(firstUserMsg.parts[0].text.substring(0, 25)) + '...' : 'Our Chat ♡';
                         const chatDate = new Date(parseInt(id));
                         const dateString = isNaN(chatDate) ? 'Unknown Date' : chatDate.toLocaleDateString();
                         button.textContent = `${dateString} - ${preview}`;
                         button.title = `Load our chat from ${isNaN(chatDate) ? id : chatDate.toLocaleString()}`;
                         button.onclick = () => loadChat(id);
                         historyDropdown.appendChild(button);
                    } else { console.warn(`Skipping invalid chat data for ID: ${id}`); }
                });
             }
             const deleteAllBtn = document.createElement('button');
             deleteAllBtn.textContent = 'Delete ALL Chats!';
             deleteAllBtn.className = 'delete-history';
             deleteAllBtn.title = 'Erase everything we talked about?! Are you sure, Master?!';
             deleteAllBtn.onclick = deleteAllChats;
             historyDropdown.appendChild(deleteAllBtn);
        }

        // --- API Call & Message Handling ---
        async function handleSendMessage() { /* ... (same as before, calls addMemory which now adds the flag) ... */
            const messageText = chatInput.value.trim();
            const userNameForApi = currentUserName;

            if (!messageText || isMikaTyping || !currentApiKey) {
                if (!currentApiKey) appendMessage('system', '*Hiss!* Master, I need the secret code first!');
                return;
            }

            appendMessage('user', messageText);
            currentChatHistory.push({ role: 'user', parts: [{ text: messageText }] });
            chatInput.value = '';
            isMikaTyping = true;
            disableChatInput("Mika is thinking about you~ *purrrr*");
            showTypingIndicator();

             let historyToSend = currentChatHistory;
             if (historyToSend.length > MAX_HISTORY_LENGTH) {
                 historyToSend = historyToSend.slice(-MAX_HISTORY_LENGTH);
                 console.log(`Chat history pruned to ${MAX_HISTORY_LENGTH} messages for API call.`);
             }

            try {
                const recentMemories = getRecentMemories();
                const mikaResponse = await sendMessageToMika(messageText, historyToSend, currentApiKey, userNameForApi, recentMemories);
                removeTypingIndicator();

                if (typeof mikaResponse === 'string' && mikaResponse.trim().length > 0) {
                    appendMessage('Mika', mikaResponse, true);
                    currentChatHistory.push({ role: 'model', parts: [{ text: mikaResponse }] });

                    // Save Mika's response as a memory point (initialized with alreadyPurrfect: false)
                    if (!mikaResponse.startsWith("*") && mikaResponse.length > 20) {
                        addMemory(mikaResponse); // addMemory now sets alreadyPurrfect to false
                    }
                    saveAllChats();
                } else {
                     console.warn("Received empty or invalid response from API, not saving.");
                }
            } catch (error) {
                console.error("Error in handleSendMessage:", error);
                removeTypingIndicator();
                const errorMessage = error.message || `Something went wrong, ${userNameForApi}... Mika got confused! Try again? ;_;`;
                appendMessage('system', sanitizeHTML(errorMessage));
            } finally {
                isMikaTyping = false;
                if (currentApiKey) { enableChatInput(); }
                else { disableChatInput("Secret code needed, Master!"); }
            }
        }

        // --- Initialization Flow ---
        function proceedToChat() { /* ... (same as before) ... */
            chatContainer.style.display = 'flex';
            loadMemories();
            const mostRecentChatId = loadAllChats();
            clearChatDisplay();
            updateInputPlaceholder();
            if (mostRecentChatId && allChats[mostRecentChatId]) {
                loadChat(mostRecentChatId);
            } else {
                if (mostRecentChatId) { console.warn(`Most recent chat ID ${mostRecentChatId} found, but data was missing/invalid. Starting new.`); }
                startNewChat(true);
            }
            updateChatTitle();
            updateHistoryDropdown();
            setupInstallPrompt();
        }
        function checkNameAndProceed() { /* ... (same as before) ... */
            const storedName = loadUserName();
            if (storedName && typeof storedName === 'string' && storedName.trim().length > 0) {
                currentUserName = storedName;
                namePopup.style.display = 'none';
                updateInputPlaceholder();
                proceedToChat();
            } else {
                if (storedName !== null) clearUserName();
                currentUserName = "Master";
                nameInput.value = "Master";
                namePopup.style.display = 'flex';
                nameInput.focus(); nameInput.select();
            }
        }
        function initializeApp() { /* ... (same as before) ... */
            registerServiceWorker();
            const loadedKey = loadApiKey();
            if (loadedKey && typeof loadedKey === 'string' && loadedKey.trim().length > 0) {
                currentApiKey = loadedKey;
                apiKeyPopup.style.display = 'none';
                checkNameAndProceed();
            } else {
                if (loadedKey !== null) clearApiKey();
                apiKeyPopup.style.display = 'flex';
                chatContainer.style.display = 'none';
                disableChatInput("Secret code needed, Master!");
                apiKeyInput.focus();
            }
        }

        // --- Event Listeners ---
        saveApiKeyButton.addEventListener('click', () => { /* ... (same as before) ... */
            const key = apiKeyInput.value.trim();
            if (key) {
                if (saveApiKey(key)) {
                    currentApiKey = key;
                    apiKeyPopup.style.display = 'none'; apiKeyError.style.display = 'none'; checkNameAndProceed();
                } else { apiKeyError.textContent = "*Mrow!* Couldn't save the key!"; apiKeyError.style.display = 'block'; }
            } else { apiKeyError.textContent = "*Hiss!* Master! You forgot the key!"; apiKeyError.style.display = 'block'; }
        });
        saveNameButton.addEventListener('click', () => { /* ... (same as before) ... */
             let name = nameInput.value.trim();
             if (!name) name = "Master";
             if (saveUserName(name)) {
                 currentUserName = name;
                 namePopup.style.display = 'none'; nameError.style.display = 'none';
                 updateInputPlaceholder(); updateChatTitle(); proceedToChat();
             } else { nameError.textContent = "*Whimper...* Couldn't save your name!"; nameError.style.display = 'block'; }
         });
        apiKeyInput.addEventListener('input', () => { /* ... (same as before) ... */
            if (apiKeyError.style.display === 'block') apiKeyError.style.display = 'none';
        });
        apiKeyInput.addEventListener('keypress', (event) => { /* ... (same as before) ... */
            if (event.key === 'Enter') saveApiKeyButton.click();
        });
        nameInput.addEventListener('input', () => { /* ... (same as before) ... */
             if (nameError.style.display === 'block') nameError.style.display = 'none';
         });
         nameInput.addEventListener('keypress', (event) => { /* ... (same as before) ... */
             if (event.key === 'Enter') saveNameButton.click();
         });
        sendButton.addEventListener('click', handleSendMessage);
        chatInput.addEventListener('keypress', (event) => { /* ... (same as before) ... */
            if (event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); handleSendMessage(); }
        });
        settingsButton.addEventListener('click', () => { /* ... (same as before) ... */
             if (confirm(`Master ${currentUserName}! Want to change the secret code or your name? I'll have to restart and forget our current chat... is that okay?`)) {
                 clearApiKey(); clearUserName(); clearFromLocalStorage(INSTALL_PROMPT_KEY); window.location.reload();
             }
        });
        newChatButton.addEventListener('click', () => startNewChat(true));
        historyButton.addEventListener('click', (event) => { /* ... (same as before) ... */
             event.stopPropagation();
             if (historyDropdown.style.display === 'block') { historyDropdown.style.display = 'none'; }
             else { updateHistoryDropdown(); historyDropdown.style.display = 'block'; }
         });
        memoriesButton.addEventListener('click', () => { /* ... (same as before) ... */
            saveAllChats(); // Save current chat before navigating
            window.location.href = 'memories.html';
        });
        document.addEventListener('click', (event) => { /* ... (same as before) ... */
             if (historyDropdown && historyDropdown.style.display === 'block' && !historyDropdown.contains(event.target) && event.target !== historyButton) {
                 historyDropdown.style.display = 'none';
             }
         });

        // --- Start the App ---
        initializeApp();

        // Auto-save chats
        window.addEventListener('beforeunload', saveAllChats);

        // Nyaa~! Ready to play with my Master! ♡

    </script>

</body>
</html>